# è»Šä¸¡äºˆç´„ã‚·ã‚¹ãƒ†ãƒ æ”¹å–„è¨ˆç”»

## ğŸ“‹ æ¦‚è¦

ç¾åœ¨ã®å…¬ç”¨è»Šç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã«é©åˆ‡ãªäºˆç´„æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã€æ™‚é–“å¸¯ç®¡ç†ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†ã‚’æ”¹å–„ã™ã‚‹ãŸã‚ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã™ã€‚

### æ”¹å–„ã®èƒŒæ™¯

- **ç¾åœ¨ã®èª²é¡Œ**: äºˆç´„æ©Ÿèƒ½ãŒæœªå®Ÿè£…ï¼ˆãƒœã‚¿ãƒ³ã¯å­˜åœ¨ã™ã‚‹ãŒæ©Ÿèƒ½ã—ãªã„ï¼‰
- **ãƒ“ã‚¸ãƒã‚¹è¦ä»¶**: å°†æ¥ã®äºˆç´„ã€æ™‚é–“å¸¯é‡è¤‡é˜²æ­¢ã€é©åˆ‡ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†
- **æŠ€è¡“çš„èª²é¡Œ**: DrivingLogãŒäºˆç´„ã¨å®Ÿéš›ã®é‹è»¢è¨˜éŒ²ã‚’å…¼ã­ã¦ã„ã‚‹è¨­è¨ˆ

### æœŸå¾…ã•ã‚Œã‚‹æˆæœ

- âœ… é©åˆ‡ãªäºˆç´„ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿç¾
- âœ… æ™‚é–“å¸¯ç®¡ç†ã®æ­£ç¢ºæ€§å‘ä¸Š
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£ã®å¤§å¹…æ”¹å–„
- âœ… å°†æ¥æ‹¡å¼µæ€§ã®ç¢ºä¿

---

## ğŸ” ç¾åœ¨ã®çŠ¶æ³åˆ†æ

### å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½
- âœ… è»Šä¸¡ä¸€è¦§è¡¨ç¤ºï¼ˆå®Œå…¨å‹•ä½œï¼‰
- âœ… ä½¿ç”¨ä¸­è»Šä¸¡è¡¨ç¤ºï¼ˆå®Œå…¨å‹•ä½œï¼‰
- âœ… çµ±è¨ˆãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºï¼ˆå®Œå…¨å‹•ä½œï¼‰
- âœ… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥è¡¨ç¤ºï¼ˆå®Œå…¨å‹•ä½œï¼‰

### æœªå®Ÿè£…æ©Ÿèƒ½
- âŒ äºˆç´„ãƒœã‚¿ãƒ³æ©Ÿèƒ½ï¼ˆè¦‹ãŸç›®ã®ã¿ï¼‰
- âŒ äºˆç´„ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå­˜åœ¨ã—ãªã„ï¼‰
- âŒ äºˆç´„ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆå®Œå…¨ã«æœªå®Ÿè£…ï¼‰

### æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: Next.js 15.4.6, React 19.1.0, TypeScript
- **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**: Prisma ORM, PostgreSQL
- **UI**: Tailwind CSS, Radix UI components
- **ãƒ•ã‚©ãƒ¼ãƒ **: React Hook Form + Zodï¼ˆæ–°è¦å°å…¥æ¸ˆã¿ï¼‰

---

## ğŸ¯ æ–°ã—ã„DBè¨­è¨ˆ

### è¨­è¨ˆæ–¹é‡
1. **è²¬ä»»ã®åˆ†é›¢**: äºˆç´„ç®¡ç†ã¨é‹è»¢è¨˜éŒ²ã‚’å®Œå…¨åˆ†é›¢
2. **å¾Œæ–¹äº’æ›æ€§**: æ—¢å­˜æ©Ÿèƒ½ã‚’å£Šã•ãªã„
3. **æ®µéšçš„ç§»è¡Œ**: ãƒªã‚¹ã‚¯ã‚’æœ€å°åŒ–

### æ–°ã—ã„ã‚¹ã‚­ãƒ¼ãƒ

#### 1. äºˆç´„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆæ–°è¦ï¼‰
```prisma
enum ReservationStatus {
  PENDING    // äºˆç´„ç¢ºå®šã€ä½¿ç”¨é–‹å§‹å¾…ã¡
  ACTIVE     // ç¾åœ¨ä½¿ç”¨ä¸­
  COMPLETED  // ä½¿ç”¨å®Œäº†
  CANCELLED  // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿
}
```

#### 2. è»Šä¸¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆæ‹¡å¼µï¼‰
```prisma
enum VehicleStatus {
  AVAILABLE   // åˆ©ç”¨å¯èƒ½
  RESERVED    // äºˆç´„æ¸ˆã¿ï¼ˆè¤‡æ•°äºˆç´„å¯èƒ½ï¼‰â† æ–°è¦è¿½åŠ 
  IN_USE      // å®Ÿéš›ã«ä½¿ç”¨ä¸­ï¼ˆ1å°ã«ã¤ã1ã¤ã®ã¿ï¼‰
  MAINTENANCE // ç‚¹æ¤œä¸­
}
```

#### 3. äºˆç´„ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ–°è¦ï¼‰
```prisma
model Reservation {
  id          String            @id @default(cuid())
  start_time  DateTime          // äºˆç´„é–‹å§‹æ™‚åˆ»
  end_time    DateTime          // äºˆç´„çµ‚äº†æ™‚åˆ»
  purpose     String?           // åˆ©ç”¨ç›®çš„ãƒ»è¡Œãå…ˆ
  status      ReservationStatus @default(PENDING)
  created_at  DateTime          @default(now())
  updated_at  DateTime          @updatedAt
  
  // å¤–éƒ¨ã‚­ãƒ¼
  user_id     String
  vehicle_id  String
  
  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  user        User              @relation(fields: [user_id], references: [id])
  vehicle     Vehicle           @relation(fields: [vehicle_id], references: [id])
  driving_log DrivingLog?       // 1å¯¾1ï¼ˆä»»æ„ï¼‰ï¼šäºˆç´„â†’é‹è»¢è¨˜éŒ²ã®å¤‰æ›
  
  // é‡è¤‡é˜²æ­¢ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
  @@index([vehicle_id, start_time, end_time])
  @@map("reservations")
}
```

#### 4. é‹è»¢æ—¥èªŒãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆè»½å¾®ä¿®æ­£ï¼‰
```prisma
model DrivingLog {
  // æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ã™ã¹ã¦ç¶­æŒ
  id             String    @id @default(cuid())
  start_time     DateTime  // é‹è»¢é–‹å§‹æ™‚åˆ»
  end_time       DateTime? // é‹è»¢çµ‚äº†æ™‚åˆ»ï¼ˆä»»æ„ï¼‰
  start_meter    Int?      // é–‹å§‹æ™‚ãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼ˆä»»æ„ï¼‰
  end_meter      Int?      // çµ‚äº†æ™‚ãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼ˆä»»æ„ï¼‰
  destination    String?   // è¡Œãå…ˆ
  is_refueling   Boolean   @default(false) // çµ¦æ²¹æœ‰ç„¡
  notes          String?   // å‚™è€ƒï¼ˆä»»æ„ï¼‰
  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt
  
  // å¤–éƒ¨ã‚­ãƒ¼ï¼ˆæ—¢å­˜ï¼‰
  vehicle_id     String
  user_id        String
  
  // æ–°è¦è¿½åŠ ï¼ˆä»»æ„ï¼‰
  reservation_id String?   @unique
  
  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  vehicle        Vehicle      @relation(fields: [vehicle_id], references: [id])
  user           User         @relation(fields: [user_id], references: [id])
  reservation    Reservation? @relation(fields: [reservation_id], references: [id])
  
  @@map("driving_logs")
}
```

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼è¨­è¨ˆ

#### äºˆç´„ä½œæˆãƒ•ãƒ­ãƒ¼
```mermaid
graph TD
    A[ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒäºˆç´„ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯] --> B[ReservationModalè¡¨ç¤º]
    B --> C[ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›ãƒ»é€ä¿¡]
    C --> D[é‡è¤‡ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ]
    D --> E{æ™‚é–“é‡è¤‡?}
    E -->|Yes| F[ã‚¨ãƒ©ãƒ¼è¡¨ç¤º]
    E -->|No| G[äºˆç´„ä½œæˆ]
    G --> H[è»Šä¸¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°]
    H --> I[UIæ›´æ–°]
```

#### ä½¿ç”¨é–‹å§‹ãƒ•ãƒ­ãƒ¼
```mermaid
graph TD
    A[äºˆç´„æ™‚åˆ»åˆ°é”] --> B[ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½¿ç”¨é–‹å§‹]
    B --> C[é‹è»¢æ—¥èªŒä½œæˆ]
    C --> D[äºˆç´„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹â†’ACTIVE]
    D --> E[è»Šä¸¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹â†’IN_USE]
```

---

## ğŸš€ å®Ÿè£…è¨ˆç”»

### Phase 1: ãƒ‡ãƒ¼ã‚¿åŸºç›¤æ§‹ç¯‰ï¼ˆ2-3æ—¥ï¼‰

#### 1.1 Prismaã‚¹ã‚­ãƒ¼ãƒæ›´æ–°
```bash
# ãƒ•ã‚¡ã‚¤ãƒ«: prisma/schema.prisma
# ä½œæ¥­: ReservationStatus, Reservation model, VehicleStatusæ‹¡å¼µã‚’è¿½åŠ 
```

**å…·ä½“çš„ãªä½œæ¥­:**
1. `ReservationStatus` enumè¿½åŠ 
2. `VehicleStatus` ã« `RESERVED` è¿½åŠ 
3. `Reservation` modelè¿½åŠ 
4. `DrivingLog` ã« `reservation_id` è¿½åŠ 

#### 1.2 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
```bash
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆå¿…é ˆï¼‰
pg_dump your_database > backup_before_reservation_migration.sql

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆãƒ»å®Ÿè¡Œ
npx prisma migrate dev --name add_reservation_system
```

#### 1.3 ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿èª¿æ•´
```typescript
// ãƒ•ã‚¡ã‚¤ãƒ«: prisma/seed.ts
// ä½œæ¥­: äºˆç´„ãƒ‡ãƒ¼ã‚¿ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’è¿½åŠ 

const reservationData: Prisma.ReservationCreateInput[] = [
  {
    start_time: new Date("2025-08-19T10:00:00"),
    end_time: new Date("2025-08-19T15:00:00"),
    purpose: "æ±äº¬é§…ã§ã®ä¼šè­°",
    status: "PENDING",
    user: { connect: { email: "sato.hanako@company.com" } },
    vehicle: { connect: { license_plate: "å“å· 500 ã‚ 1234" } }
  },
  // ä»–ã®ã‚µãƒ³ãƒ—ãƒ«äºˆç´„ãƒ‡ãƒ¼ã‚¿
];
```

#### 1.4 å‹å®šç¾©æ›´æ–°
```typescript
// ãƒ•ã‚¡ã‚¤ãƒ«: src/types/vehicle.ts
// ä½œæ¥­: Reservationå‹ã€ReservationStatuså‹ã‚’è¿½åŠ 

export interface Reservation {
  id: string;
  startTime: string;
  endTime: string;
  purpose?: string;
  status: ReservationStatus;
  userId: string;
  vehicleId: string;
  user?: User;
  vehicle?: Vehicle;
}

export type ReservationStatus = "PENDING" | "ACTIVE" | "COMPLETED" | "CANCELLED";
```

**æ¤œè¨¼ãƒã‚¤ãƒ³ãƒˆ:**
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æˆåŠŸ
- [ ] ã‚·ãƒ¼ãƒ‰å®Ÿè¡ŒæˆåŠŸ
- [ ] å‹ã‚¨ãƒ©ãƒ¼ãªã—
- [ ] æ—¢å­˜æ©Ÿèƒ½ãŒæ­£å¸¸å‹•ä½œ

---

### Phase 2: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIå®Ÿè£…ï¼ˆ3-4æ—¥ï¼‰

#### 2.1 äºˆç´„ç®¡ç†Actions
```typescript
// ãƒ•ã‚¡ã‚¤ãƒ«: src/lib/actions/reservation-actions.tsï¼ˆæ–°è¦ä½œæˆï¼‰

"use server";

import { revalidatePath } from "next/cache";
import { reservationSchema } from "@/lib/schemas/reservation";
import prisma from "@/lib/prisma";

export async function createReservationAction(formData: FormData) {
  // 1. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  const validatedFields = reservationSchema.safeParse({
    vehicleId: formData.get("vehicleId"),
    startDateTime: formData.get("startDateTime"),
    endDateTime: formData.get("endDateTime"),
    purpose: formData.get("purpose"),
  });

  if (!validatedFields.success) {
    return {
      error: "å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„",
      details: validatedFields.error.format(),
    };
  }

  // 2. é‡è¤‡ãƒã‚§ãƒƒã‚¯
  const conflicts = await checkTimeConflicts(
    validatedFields.data.vehicleId,
    validatedFields.data.startDateTime,
    validatedFields.data.endDateTime
  );

  if (conflicts.length > 0) {
    return {
      error: "é¸æŠã—ãŸæ™‚é–“å¸¯ã¯æ—¢ã«äºˆç´„ã•ã‚Œã¦ã„ã¾ã™",
      conflicts,
    };
  }

  try {
    // 3. äºˆç´„ä½œæˆ
    await prisma.$transaction(async (tx) => {
      const reservation = await tx.reservation.create({
        data: {
          vehicle_id: validatedFields.data.vehicleId,
          user_id: "user_id_here", // å®Ÿéš›ã®èªè¨¼ã‹ã‚‰å–å¾—
          start_time: validatedFields.data.startDateTime,
          end_time: validatedFields.data.endDateTime,
          purpose: validatedFields.data.purpose,
        },
      });

      // 4. è»Šä¸¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
      await updateVehicleStatus(validatedFields.data.vehicleId, tx);
    });

    revalidatePath("/");
    return { success: true };
  } catch (error) {
    console.error("Reservation creation failed:", error);
    return { error: "äºˆç´„ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚" };
  }
}
```

#### 2.2 é‡è¤‡ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½
```typescript
// ãƒ•ã‚¡ã‚¤ãƒ«: src/lib/utils/reservation-utils.tsï¼ˆæ–°è¦ä½œæˆï¼‰

import prisma from "@/lib/prisma";

export async function checkTimeConflicts(
  vehicleId: string,
  startTime: Date,
  endTime: Date
): Promise<Reservation[]> {
  return await prisma.reservation.findMany({
    where: {
      vehicle_id: vehicleId,
      status: {
        in: ["PENDING", "ACTIVE"], // æœ‰åŠ¹ãªäºˆç´„ã®ã¿
      },
      OR: [
        // é–‹å§‹æ™‚åˆ»ãŒæ—¢å­˜äºˆç´„ã®æœŸé–“å†…
        {
          AND: [
            { start_time: { lte: startTime } },
            { end_time: { gt: startTime } },
          ],
        },
        // çµ‚äº†æ™‚åˆ»ãŒæ—¢å­˜äºˆç´„ã®æœŸé–“å†…
        {
          AND: [
            { start_time: { lt: endTime } },
            { end_time: { gte: endTime } },
          ],
        },
        // æ—¢å­˜äºˆç´„ãŒæ–°äºˆç´„ã®æœŸé–“å†…
        {
          AND: [
            { start_time: { gte: startTime } },
            { end_time: { lte: endTime } },
          ],
        },
      ],
    },
    include: {
      user: true,
    },
  });
}
```

#### 2.3 è»Šä¸¡çŠ¶æ…‹ç®¡ç†
```typescript
// ãƒ•ã‚¡ã‚¤ãƒ«: src/lib/utils/vehicle-status.tsï¼ˆæ–°è¦ä½œæˆï¼‰

export async function updateVehicleStatus(
  vehicleId: string, 
  tx?: PrismaTransactionClient
) {
  const prismaClient = tx || prisma;

  // ç¾åœ¨æ™‚åˆ»ã§æœ‰åŠ¹ãªäºˆç´„ã‚’ãƒã‚§ãƒƒã‚¯
  const activeReservation = await prismaClient.reservation.findFirst({
    where: {
      vehicle_id: vehicleId,
      status: "ACTIVE",
    },
  });

  // å°†æ¥ã®äºˆç´„ã‚’ãƒã‚§ãƒƒã‚¯
  const futureReservations = await prismaClient.reservation.findMany({
    where: {
      vehicle_id: vehicleId,
      status: "PENDING",
      start_time: { gt: new Date() },
    },
  });

  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯
  let newStatus: VehicleStatus;
  if (activeReservation) {
    newStatus = "IN_USE";
  } else if (futureReservations.length > 0) {
    newStatus = "RESERVED";
  } else {
    newStatus = "AVAILABLE";
  }

  // è»Šä¸¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
  await prismaClient.vehicle.update({
    where: { id: vehicleId },
    data: { status: newStatus },
  });
}
```

#### 2.4 ãƒ‡ãƒ¼ã‚¿å–å¾—é–¢æ•°æ‹¡å¼µ
```typescript
// ãƒ•ã‚¡ã‚¤ãƒ«: src/lib/data.ts ã«è¿½åŠ 

export async function getReservations(userId?: string): Promise<Reservation[]> {
  const where = userId ? { user_id: userId } : {};
  
  const reservations = await prisma.reservation.findMany({
    where,
    include: {
      user: true,
      vehicle: true,
    },
    orderBy: { start_time: "asc" },
  });

  return reservations.map(dbToFrontendReservation);
}

export async function getVehicleSchedule(vehicleId: string, date: Date) {
  const startOfDay = new Date(date);
  startOfDay.setHours(0, 0, 0, 0);
  
  const endOfDay = new Date(date);
  endOfDay.setHours(23, 59, 59, 999);

  return await prisma.reservation.findMany({
    where: {
      vehicle_id: vehicleId,
      start_time: { gte: startOfDay },
      end_time: { lte: endOfDay },
      status: { in: ["PENDING", "ACTIVE"] },
    },
    include: { user: true },
    orderBy: { start_time: "asc" },
  });
}
```

**æ¤œè¨¼ãƒã‚¤ãƒ³ãƒˆ:**
- [ ] é‡è¤‡ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½å‹•ä½œ
- [ ] äºˆç´„ä½œæˆAPIå‹•ä½œ
- [ ] è»Šä¸¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°æ­£å¸¸
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°é©åˆ‡

---

### Phase 3: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…ï¼ˆ4-5æ—¥ï¼‰

#### 3.1 äºˆç´„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
```typescript
// ãƒ•ã‚¡ã‚¤ãƒ«: src/app/components/ReservationModal.tsxï¼ˆæ–°è¦ä½œæˆï¼‰

"use client";

import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { reservationSchema, type ReservationFormData } from "@/lib/schemas/reservation";
import { createReservationAction } from "@/lib/actions/reservation-actions";
import { SimpleModal } from "./SimpleModal";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Button } from "@/components/ui/button";

interface ReservationModalProps {
  vehicle: Vehicle;
  isOpen: boolean;
  onClose: () => void;
}

export function ReservationModal({ vehicle, isOpen, onClose }: ReservationModalProps) {
  const {
    register,
    handleSubmit,
    formState: { errors, isSubmitting },
    reset,
    setError,
  } = useForm<ReservationFormData>({
    resolver: zodResolver(reservationSchema),
  });

  const onSubmit = async (data: ReservationFormData) => {
    const formData = new FormData();
    formData.append("vehicleId", vehicle.id);
    formData.append("startDateTime", data.startDateTime);
    formData.append("endDateTime", data.endDateTime);
    if (data.purpose) formData.append("purpose", data.purpose);

    const result = await createReservationAction(formData);

    if (result.success) {
      reset();
      onClose();
      // æˆåŠŸé€šçŸ¥ï¼ˆå¾Œã§å®Ÿè£…ï¼‰
    } else if (result.conflicts) {
      setError("startDateTime", {
        message: `${result.conflicts[0].start_time} - ${result.conflicts[0].end_time} ã«äºˆç´„æ¸ˆã¿`,
      });
    } else {
      // ã‚¨ãƒ©ãƒ¼å‡¦ç†
      console.error(result.error);
    }
  };

  return (
    <SimpleModal
      isOpen={isOpen}
      onClose={onClose}
      title={`è»Šä¸¡äºˆç´„ - ${vehicle.licensePlate}`}
    >
      <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
        {/* è»Šä¸¡æƒ…å ±è¡¨ç¤º */}
        <div className="bg-gray-50 p-4 rounded-xl">
          <p className="text-sm font-medium text-gray-700">
            {vehicle.make} {vehicle.model} ({vehicle.year}å¹´)
          </p>
        </div>

        {/* é–‹å§‹æ—¥æ™‚ */}
        <div>
          <Label htmlFor="startDateTime">åˆ©ç”¨é–‹å§‹æ—¥æ™‚</Label>
          <Input
            id="startDateTime"
            type="datetime-local"
            {...register("startDateTime")}
            className={errors.startDateTime ? "border-red-500" : ""}
          />
          {errors.startDateTime && (
            <p className="text-red-500 text-sm mt-1">{errors.startDateTime.message}</p>
          )}
        </div>

        {/* çµ‚äº†æ—¥æ™‚ */}
        <div>
          <Label htmlFor="endDateTime">åˆ©ç”¨çµ‚äº†æ—¥æ™‚</Label>
          <Input
            id="endDateTime"
            type="datetime-local"
            {...register("endDateTime")}
            className={errors.endDateTime ? "border-red-500" : ""}
          />
          {errors.endDateTime && (
            <p className="text-red-500 text-sm mt-1">{errors.endDateTime.message}</p>
          )}
        </div>

        {/* åˆ©ç”¨ç›®çš„ */}
        <div>
          <Label htmlFor="purpose">åˆ©ç”¨ç›®çš„ï¼ˆä»»æ„ï¼‰</Label>
          <textarea
            id="purpose"
            rows={3}
            placeholder="ä¼šè­°ã€å–¶æ¥­è¨ªå•ã€ãã®ä»–æ¥­å‹™ãªã©..."
            {...register("purpose")}
            className="w-full border-0 bg-gray-50 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-purple-500 focus:bg-white transition-all shadow-sm resize-none"
          />
          {errors.purpose && (
            <p className="text-red-500 text-sm mt-1">{errors.purpose.message}</p>
          )}
        </div>

        {/* ãƒœã‚¿ãƒ³ */}
        <div className="flex justify-end space-x-4">
          <Button type="button" variant="outline" onClick={onClose}>
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </Button>
          <Button type="submit" disabled={isSubmitting}>
            {isSubmitting ? "äºˆç´„ä¸­..." : "äºˆç´„ç¢ºå®š"}
          </Button>
        </div>
      </form>
    </SimpleModal>
  );
}
```

#### 3.2 VehicleRowä¿®æ­£
```typescript
// ãƒ•ã‚¡ã‚¤ãƒ«: src/app/components/VehicleRow.tsx
// å¤‰æ›´: statusConfigã«RESERVEDè¿½åŠ ã€äºˆç´„ãƒœã‚¿ãƒ³ã«æ©Ÿèƒ½è¿½åŠ 

"use client";

import { useState } from "react";
import { Button } from "@/components/ui/button.tsx";
import type { StatusConfig, Vehicle } from "@/types/vehicle.ts";
import { ReservationModal } from "./ReservationModal";

// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨­å®šï¼ˆRESERVEDè¿½åŠ ï¼‰
const statusConfig: Record<string, StatusConfig> = {
  available: {
    label: "åˆ©ç”¨å¯èƒ½",
    bgGradient: "from-blue-100 to-cyan-100",
    textColor: "text-blue-700",
    buttonDisabled: false,
  },
  reserved: { // æ–°è¦è¿½åŠ 
    label: "äºˆç´„æ¸ˆã¿",
    bgGradient: "from-yellow-100 to-amber-100",
    textColor: "text-yellow-700",
    buttonDisabled: false, // äºˆç´„å¯èƒ½ï¼ˆè¤‡æ•°äºˆç´„å¯¾å¿œï¼‰
  },
  "in-use": {
    label: "ä½¿ç”¨ä¸­",
    bgGradient: "from-pink-100 to-rose-100",
    textColor: "text-pink-700",
    buttonDisabled: true,
  },
  maintenance: {
    label: "ç‚¹æ¤œä¸­",
    bgGradient: "from-orange-100 to-red-100",
    textColor: "text-orange-700",
    buttonDisabled: true,
  },
};

interface VehicleRowProps {
  vehicle: Vehicle;
}

export const VehicleRow = ({ vehicle }: VehicleRowProps) => {
  const [isModalOpen, setIsModalOpen] = useState(false);
  const IconComponent = vehicle.icon;
  const status = statusConfig[vehicle.status];

  return (
    <>
      <tr className="hover:bg-white/80 transition-all duration-200">
        {/* æ—¢å­˜ã®tdã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯å¤‰æ›´ãªã— */}
        <td className="px-8 py-6 whitespace-nowrap">
          {/* è»Šä¸¡æƒ…å ± */}
        </td>
        <td className="px-8 py-6 whitespace-nowrap">
          {/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */}
        </td>
        <td className="px-8 py-6 whitespace-nowrap text-sm text-gray-600 font-medium">
          {/* ç¾åœ¨ã®åˆ©ç”¨è€… */}
        </td>
        <td className="px-8 py-6 whitespace-nowrap text-sm text-gray-600 font-medium">
          {/* æ¬¡å›ç‚¹æ¤œæ—¥ */}
        </td>
        
        {/* æ“ä½œåˆ— - äºˆç´„ãƒœã‚¿ãƒ³ã«æ©Ÿèƒ½è¿½åŠ  */}
        <td className="px-8 py-6 whitespace-nowrap text-sm font-medium space-x-3">
          <Button
            className={`px-4 py-2 rounded-xl transition-all shadow-md ${
              status.buttonDisabled
                ? "bg-gray-200 text-gray-400 cursor-not-allowed"
                : "bg-gradient-to-r from-purple-600 to-indigo-700 hover:from-purple-700 hover:to-indigo-800 text-white hover:shadow-lg transform hover:scale-105"
            }`}
            disabled={status.buttonDisabled}
            onClick={() => setIsModalOpen(true)} // æ©Ÿèƒ½è¿½åŠ 
          >
            äºˆç´„
          </Button>
          <Button className="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-xl transition-all shadow-md hover:shadow-lg">
            è©³ç´°
          </Button>
        </td>
      </tr>

      {/* äºˆç´„ãƒ¢ãƒ¼ãƒ€ãƒ« */}
      <ReservationModal
        vehicle={vehicle}
        isOpen={isModalOpen}
        onClose={() => setIsModalOpen(false)}
      />
    </>
  );
};
```

#### 3.3 çµ±è¨ˆãƒ‡ãƒ¼ã‚¿æ›´æ–°
```typescript
// ãƒ•ã‚¡ã‚¤ãƒ«: src/lib/data.ts
// getVehicleStatsé–¢æ•°ã‚’ä¿®æ­£

export async function getVehicleStats(): Promise<{
  total: number;
  available: number;
  reserved: number; // æ–°è¦è¿½åŠ 
  inUse: number;
  maintenance: number;
}> {
  try {
    const total = await prisma.vehicle.count();
    const available = await prisma.vehicle.count({
      where: { status: "AVAILABLE" },
    });
    const reserved = await prisma.vehicle.count({ // æ–°è¦è¿½åŠ 
      where: { status: "RESERVED" },
    });
    const inUse = await prisma.vehicle.count({
      where: { status: "IN_USE" },
    });
    const maintenance = await prisma.vehicle.count({
      where: { status: "MAINTENANCE" },
    });

    return { total, available, reserved, inUse, maintenance };
  } catch (error) {
    console.error("Error fetching vehicle stats:", error);
    throw new Error("Failed to fetch vehicle stats");
  }
}
```

**æ¤œè¨¼ãƒã‚¤ãƒ³ãƒˆ:**
- [ ] äºˆç´„ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºãƒ»éè¡¨ç¤º
- [ ] ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å‹•ä½œ
- [ ] é‡è¤‡ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
- [ ] äºˆç´„æˆåŠŸæ™‚ã®UIæ›´æ–°
- [ ] æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º

---

### Phase 4: çµ±åˆãƒ»ãƒ†ã‚¹ãƒˆï¼ˆ2-3æ—¥ï¼‰

#### 4.1 ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ

**ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª:**

1. **æ­£å¸¸äºˆç´„ãƒ•ãƒ­ãƒ¼**
   - åˆ©ç”¨å¯èƒ½è»Šä¸¡ã§äºˆç´„ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
   - é©åˆ‡ãªæ—¥æ™‚ã‚’å…¥åŠ›ã—ã¦äºˆç´„ç¢ºå®š
   - è»Šä¸¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒRESERVEDã«å¤‰æ›´ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
   - çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

2. **é‡è¤‡äºˆç´„ãƒ†ã‚¹ãƒˆ**
   - æ—¢å­˜äºˆç´„ã¨é‡è¤‡ã™ã‚‹æ™‚é–“ã§äºˆç´„ã‚’è©¦è¡Œ
   - é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

3. **ä½¿ç”¨é–‹å§‹ãƒ•ãƒ­ãƒ¼**ï¼ˆå°†æ¥ã®æ©Ÿèƒ½ï¼‰
   - äºˆç´„æ™‚åˆ»åˆ°é”æ™‚ã®å‹•ä½œç¢ºèª
   - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»ã®ç¢ºèª

#### 4.2 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ

```typescript
// é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–ç¢ºèª
// ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŠ¹æœã®æ¤œè¨¼
// å¤§é‡ãƒ‡ãƒ¼ã‚¿ã§ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“æ¸¬å®š
```

#### 4.3 ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯

```sql
-- äºˆç´„ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
SELECT 
  r1.id, r1.vehicle_id, r1.start_time, r1.end_time,
  r2.id, r2.start_time, r2.end_time
FROM reservations r1
JOIN reservations r2 ON (
  r1.vehicle_id = r2.vehicle_id 
  AND r1.id != r2.id
  AND r1.status IN ('PENDING', 'ACTIVE')
  AND r2.status IN ('PENDING', 'ACTIVE')
  AND (
    (r1.start_time < r2.end_time AND r1.end_time > r2.start_time)
  )
);
```

**æ¤œè¨¼ãƒã‚¤ãƒ³ãƒˆ:**
- [ ] å…¨æ©Ÿèƒ½ã®çµ±åˆå‹•ä½œç¢ºèª
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶é”æˆ
- [ ] ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ä¿è¨¼
- [ ] ã‚¨ãƒ©ãƒ¼å‡¦ç†ã®å®Œå…¨æ€§

---

## ğŸ“Š ãƒªã‚¹ã‚¯ç®¡ç†

### é«˜ãƒªã‚¹ã‚¯é …ç›®

1. **ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ**
   - **ãƒªã‚¹ã‚¯**: æ—¢å­˜ã®é€²è¡Œä¸­DrivingLogãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§
   - **å¯¾ç­–**: æ®µéšçš„ç§»è¡Œã€å®Œå…¨ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã€ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æº–å‚™

2. **æ™‚é–“å¸¯é‡è¤‡ãƒ­ã‚¸ãƒƒã‚¯**
   - **ãƒªã‚¹ã‚¯**: è¤‡é›‘ãªé‡è¤‡åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã®ãƒã‚°
   - **å¯¾ç­–**: ååˆ†ãªå˜ä½“ãƒ†ã‚¹ãƒˆã€å¢ƒç•Œå€¤ãƒ†ã‚¹ãƒˆ

3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**
   - **ãƒªã‚¹ã‚¯**: é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚¯ã‚¨ãƒªã®é‡ã•
   - **å¯¾ç­–**: é©åˆ‡ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆã€ã‚¯ã‚¨ãƒªæœ€é©åŒ–

### ä¸­ãƒªã‚¹ã‚¯é …ç›®

1. **UI/UX**
   - **ãƒªã‚¹ã‚¯**: è¤‡é›‘ãªäºˆç´„ãƒ•ãƒ­ãƒ¼ã§ã®åˆ©ç”¨è€…ã®æ··ä¹±
   - **å¯¾ç­–**: æ®µéšçš„å®Ÿè£…ã€é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

2. **çŠ¶æ…‹ç®¡ç†**
   - **ãƒªã‚¹ã‚¯**: è»Šä¸¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ä¸æ•´åˆ
   - **å¯¾ç­–**: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é©ç”¨ã€å®šæœŸçš„ãªæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯

### ç·Šæ€¥æ™‚å¯¾å¿œ

#### ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †

1. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯**
```bash
# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰ã®å¾©æ—§
psql database_name < backup_before_reservation_migration.sql
```

2. **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯**
```bash
# å‰ã®ã‚³ãƒŸãƒƒãƒˆã«æˆ»ã‚‹
git revert HEAD
npm run build && npm run start
```

---

## ğŸ“ˆ æˆåŠŸæŒ‡æ¨™

### æŠ€è¡“æŒ‡æ¨™
- [ ] äºˆç´„ä½œæˆãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ < 2ç§’
- [ ] é‡è¤‡ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œæ™‚é–“ < 500ms
- [ ] UIæ“ä½œã®å¿œç­”æ€§ç¢ºä¿
- [ ] ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã‚¨ãƒ©ãƒ¼ 0ä»¶

### ãƒ“ã‚¸ãƒã‚¹æŒ‡æ¨™
- [ ] äºˆç´„æ©Ÿèƒ½ã®åˆ©ç”¨ç‡
- [ ] äºˆç´„é‡è¤‡ã‚¨ãƒ©ãƒ¼ã®ç™ºç”Ÿç‡
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã®ç›´æ„Ÿæ€§
- [ ] ã‚·ã‚¹ãƒ†ãƒ ã®å®‰å®šæ€§

---

## ğŸ¯ å°†æ¥ã®æ‹¡å¼µè¨ˆç”»

### Phase 5ä»¥é™ã§æ¤œè¨ã™ã‚‹æ©Ÿèƒ½

1. **é«˜åº¦ãªäºˆç´„ç®¡ç†**
   - å®šæœŸäºˆç´„ï¼ˆæ¯é€±é‡‘æ›œæ—¥ãªã©ï¼‰
   - äºˆç´„å¤‰æ›´ãƒ»å»¶é•·æ©Ÿèƒ½
   - äºˆç´„é€šçŸ¥ãƒ»ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼

2. **ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½**
   - è»Šä¸¡åˆ©ç”¨ç‡ãƒ¬ãƒãƒ¼ãƒˆ
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥åˆ©ç”¨çµ±è¨ˆ
   - äºˆç´„ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ

3. **ç®¡ç†è€…æ©Ÿèƒ½**
   - äºˆç´„ã®å¼·åˆ¶ã‚­ãƒ£ãƒ³ã‚»ãƒ«
   - ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹äºˆç´„ã®ç™»éŒ²
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ç®¡ç†

4. **APIæ‹¡å¼µ**
   - å¤–éƒ¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨ã®é€£æº
   - ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªå¯¾å¿œ
   - Webhooké€šçŸ¥

---

## ğŸ“ å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### Phase 1: ãƒ‡ãƒ¼ã‚¿åŸºç›¤
- [ ] Prismaã‚¹ã‚­ãƒ¼ãƒæ›´æ–°
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
- [ ] ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿èª¿æ•´
- [ ] å‹å®šç¾©æ›´æ–°
- [ ] æ—¢å­˜æ©Ÿèƒ½ã®å‹•ä½œç¢ºèª

### Phase 2: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
- [ ] äºˆç´„ä½œæˆActionå®Ÿè£…
- [ ] é‡è¤‡ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½å®Ÿè£…
- [ ] è»Šä¸¡çŠ¶æ…‹ç®¡ç†å®Ÿè£…
- [ ] ãƒ‡ãƒ¼ã‚¿å–å¾—é–¢æ•°æ‹¡å¼µ
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å®Ÿè£…
- [ ] å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

### Phase 3: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
- [ ] ReservationModalå®Ÿè£…
- [ ] VehicleRowæ©Ÿèƒ½è¿½åŠ 
- [ ] statusConfigæ‹¡å¼µ
- [ ] çµ±è¨ˆãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºæ›´æ–°
- [ ] UI/UXãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

### Phase 4: çµ±åˆãƒ»ãƒ†ã‚¹ãƒˆ
- [ ] ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
- [ ] ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ
- [ ] æœ¬ç•ªãƒªãƒªãƒ¼ã‚¹æº–å‚™

---

## ğŸ“ ã‚µãƒãƒ¼ãƒˆãƒ»è³ªå•

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å†…å®¹ã«ã¤ã„ã¦è³ªå•ãŒã‚ã‚‹å ´åˆã¯ã€å„ãƒ•ã‚§ãƒ¼ã‚ºã®å®Ÿè£…å‰ã«è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

**é‡è¦**: å„ãƒ•ã‚§ãƒ¼ã‚ºã®å®Œäº†æ™‚ã«ã¯å¿…ãšãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã‚Šã€æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºã«é€²ã‚€å‰ã«å‹•ä½œç¢ºèªã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

---

*æœ€çµ‚æ›´æ–°: 2025-08-19*  
*ä½œæˆè€…: Claude Code Assistant*